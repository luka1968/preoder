# 🚀 上线前最终检查清单

---

## ✅ 已完成的修复

- [x] OAuth State 验证添加
- [x] 前端 API URL 动态化
- [x] 数据库外键类型修复
- [x] Shops 表更新
- [x] Preorder_orders 表创建

---

## 📋 上线前必做事项

### 1️⃣ 代码提交到 Git **⚠️ 必须**

```bash
cd d:\360\git2\preoder

# 查看修改的文件
git status

# 添加所有修改
git add .

# 提交
git commit -m "fix: P0问题修复 - OAuth安全、前端配置、数据库外键"

# 推送到远程
git push origin main
```

**为什么必须**: Vercel 从 Git 仓库部署，不提交代码就无法部署新版本。

---

### 2️⃣ 等待 Vercel 自动部署 **⚠️ 必须**

1. 访问 Vercel Dashboard: https://vercel.com
2. 找到你的项目（`preoder`）
3. 等待自动部署完成（通常 2-3 分钟）
4. 检查部署状态：
   - ✅ 状态显示 "Ready"
   - ✅ 没有构建错误

**期望结果**: 
```
✅ Deployment successful
```

---

### 3️⃣ 验证环境变量 **⚠️ 重要**

在 Vercel 项目设置中确认：

```env
✅ SHOPIFY_API_KEY=你的值
✅ SHOPIFY_API_SECRET=你的值  
✅ SHOPIFY_APP_URL=https://shopmall.dpdns.org
✅ SUPABASE_URL=https://your-project.supabase.co
✅ SUPABASE_SERVICE_ROLE_KEY=你的值
✅ NEXT_PUBLIC_SUPABASE_ANON_KEY=你的值
✅ JWT_SECRET=至少32字符
✅ SMTP_HOST=smtp服务器
✅ SMTP_PASS=smtp密码
```

**检查方法**:
- Vercel Dashboard → 项目 → Settings → Environment Variables

---

### 4️⃣ 测试 OAuth 安装流程 **🧪 关键测试**

#### 测试步骤:

1. **清除之前的安装记录**（如果有）:
   ```sql
   -- 在 Supabase SQL Editor
   DELETE FROM shops WHERE shop_domain = 'anvi-shop.myshopify.com';
   ```

2. **访问安装链接**:
   ```
   https://shopmall.dpdns.org/api/auth?shop=anvi-shop.myshopify.com
   ```

3. **期望流程**:
   - ✅ 跳转到 Shopify 授权页面
   - ✅ 显示权限列表
   - ✅ 点击 "Install app"
   - ✅ 回调成功
   - ✅ 重定向到 `/admin?shop=...`

4. **验证数据库**:
   ```sql
   SELECT * FROM shops WHERE shop_domain = 'anvi-shop.myshopify.com';
   ```
   
   应该看到：
   - ✅ `access_token` 有值
   - ✅ `is_active` = true
   - ✅ `installed_at` 有时间

5. **检查 Vercel Logs**:
   - 应该看到成功日志：
   ```
   ✅ OAuth验证通过 for shop: anvi-shop.myshopify.com
   ✅ Access token obtained
   ✅ Shop data saved to database
   ```

---

### 5️⃣ 测试预购订单创建 **🧪 关键测试**

#### 方式 A: 通过前端测试（推荐）

1. **在 Shopify 设置一个测试产品**:
   - 库存设为 0
   - 在应用中启用预购

2. **访问产品页面**:
   - 应该看到 "Pre-Order Now" 按钮
   - 点击按钮，填写表单
   - 提交

3. **验证订单创建**:
   ```sql
   SELECT * FROM preorder_orders ORDER BY created_at DESC LIMIT 1;
   ```
   
   应该看到：
   - ✅ `shop_id` 有值（BIGINT类型）
   - ✅ `customer_email` 正确
   - ✅ `shopify_order_id` 有值（Draft Order ID）

4. **检查 Shopify Draft Orders**:
   - 登录 Shopify Admin
   - Orders → Drafts
   - ✅ 应该看到新的 Draft Order

#### 方式 B: 直接 API 测试

使用 Postman 或 curl:

```bash
curl -X POST https://shopmall.dpdns.org/api/preorder/create \
  -H "Content-Type: application/json" \
  -d '{
    "shop": "anvi-shop.myshopify.com",
    "productId": "测试产品ID",
    "variantId": "测试变体ID",
    "email": "test@example.com",
    "name": "Test User"
  }'
```

**期望响应**:
```json
{
  "success": true,
  "message": "预购提交成功",
  "preorder": {
    "id": 1,
    "draftOrderId": "123456"
  }
}
```

---

### 6️⃣ 检查错误日志 **⚠️ 必须**

在 Vercel 查看 Function Logs:

1. Vercel Dashboard → 项目 → Logs
2. 筛选 `/api/auth/callback` 和 `/api/preorder/create`
3. 确认：
   - ❌ 没有严重错误（5xx）
   - ❌ 没有数据库连接错误
   - ❌ 没有 CORS 错误

---

## 🚨 上线前最后确认

请逐项确认：

- [ ] 代码已提交并推送到 Git
- [ ] Vercel 部署成功（显示 Ready）
- [ ] 环境变量全部配置正确
- [ ] OAuth 安装流程测试通过
- [ ] 可以成功创建 Draft Order
- [ ] Supabase 数据正确保存
- [ ] Vercel Logs 无严重错误
- [ ] 前端预购按钮显示正常

---

## ⚠️ 如果测试失败

### OAuth 失败
- 检查 `SHOPIFY_API_SECRET` 是否正确
- 检查 Shopify Partner 的 Redirect URLs
- 查看 Vercel Logs 的详细错误

### 数据库插入失败
- 检查 `SUPABASE_SERVICE_ROLE_KEY`
- 确认表结构正确
- 查看 Supabase Logs

### Draft Order 创建失败
- 检查 Shopify API Scopes 是否包含 `write_draft_orders`
- 确认 `access_token` 有效
- 检查产品和变体 ID 是否正确

---

## ✅ 上线后监控

上线后的前 24 小时，定期检查：

1. **Vercel Logs** - 每小时检查一次
2. **Supabase Database** - 确认订单正常创建
3. **Shopify Draft Orders** - 验证订单同步
4. **用户反馈** - 收集使用问题

---

## 🎉 如果所有测试通过

**恭喜！你的应用已经可以上线了！** 🚀

下一步可以：
1. 在其他商店测试
2. 优化前端样式
3. 实现 P1 功能（邮件通知、库存同步）
4. 提交到 Shopify App Store（如需）

---

**准备好开始测试了吗？**

从第一步开始：提交代码到 Git！
