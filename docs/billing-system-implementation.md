# è®¡è´¹ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

PreOrder Pro è®¡è´¹ç³»ç»Ÿå®Œå…¨æŒ‰ç…§éœ€æ±‚å®ç°ï¼Œæ”¯æŒå…è´¹ç‰ˆå’ŒProç‰ˆçš„åŠŸèƒ½é™åˆ¶å’Œä½¿ç”¨ç»Ÿè®¡ã€‚

## ğŸ“‹ å®šä»·è®¡åˆ’

### å…è´¹ç‰ˆ (Free)
- **ä»·æ ¼**: $0/æœˆ
- **é¢„å”®è®¢å•**: 1ä¸ª/æœˆ
- **è¡¥è´§é‚®ä»¶**: 50ä¸ª/æœˆ
- **éƒ¨åˆ†ä»˜æ¬¾**: âŒ ä¸æ”¯æŒ
- **æŠ˜æ‰£ç **: âŒ ä¸æ”¯æŒ
- **é‚®ä»¶æ¨¡æ¿ç¼–è¾‘**: âŒ ä¸æ”¯æŒ
- **ç§»é™¤å“ç‰Œæ ‡è¯†**: âŒ ä¸æ”¯æŒ

### Proç‰ˆ (Pro)
- **ä»·æ ¼**: $3.99/æœˆ
- **é¢„å”®è®¢å•**: 100ä¸ª/æœˆ
- **è¡¥è´§é‚®ä»¶**: 1000ä¸ª/æœˆ
- **éƒ¨åˆ†ä»˜æ¬¾**: âœ… æ”¯æŒ
- **æŠ˜æ‰£ç **: âœ… æ”¯æŒ
- **é‚®ä»¶æ¨¡æ¿ç¼–è¾‘**: âœ… æ”¯æŒ
- **ç§»é™¤å“ç‰Œæ ‡è¯†**: âœ… æ”¯æŒ

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®åº“ç»“æ„
```sql
-- å®šä»·è®¡åˆ’è¡¨
pricing_plans (
  id, name, price_monthly, price_yearly, 
  features, limits, is_active
)

-- åº—é“ºè®¢é˜…è¡¨
shop_subscriptions (
  id, shop_id, plan_id, status, billing_cycle,
  current_period_start, current_period_end
)

-- ä½¿ç”¨ç»Ÿè®¡è¡¨
usage_tracking (
  id, shop_id, subscription_id, usage_type,
  usage_count, period_start, period_end
)

-- è®¡è´¹äº‹ä»¶è¡¨
billing_events (
  id, shop_id, subscription_id, event_type, event_data
)
```

### æ ¸å¿ƒç»„ä»¶

#### 1. BillingSystem ç±» (`lib/billing-system.ts`)
- âœ… å®šä»·è®¡åˆ’ç®¡ç†
- âœ… è®¢é˜…åˆ›å»º/æ›´æ–°/å–æ¶ˆ
- âœ… ä½¿ç”¨é™åˆ¶æ£€æŸ¥
- âœ… ä½¿ç”¨ç»Ÿè®¡è·Ÿè¸ª
- âœ… åŠŸèƒ½æƒé™éªŒè¯

#### 2. UsageMiddleware ç±» (`lib/usage-middleware.ts`)
- âœ… ä½¿ç”¨é™åˆ¶ä¸­é—´ä»¶
- âœ… åŠŸèƒ½è®¿é—®æ£€æŸ¥
- âœ… è‡ªåŠ¨ä½¿ç”¨è®¡æ•°
- âœ… å“ç‰Œæ ‡è¯†æ§åˆ¶

#### 3. è®¡è´¹ç®¡ç†é¡µé¢ (`pages/billing.tsx`)
- âœ… å½“å‰è®¡åˆ’æ˜¾ç¤º
- âœ… ä½¿ç”¨ç»Ÿè®¡å›¾è¡¨
- âœ… è®¡åˆ’å‡çº§/é™çº§
- âœ… è®¡è´¹ä¿¡æ¯å±•ç¤º

## ğŸ”§ API ç«¯ç‚¹

### è®¡è´¹ç›¸å…³ API
```
GET  /api/billing/plans        # è·å–å®šä»·è®¡åˆ’
GET  /api/billing/subscription # è·å–å½“å‰è®¢é˜…
POST /api/billing/subscription # åˆ›å»ºè®¢é˜…
PUT  /api/billing/subscription # æ›´æ”¹è®¡åˆ’
DELETE /api/billing/subscription # å–æ¶ˆè®¢é˜…

GET  /api/billing/usage        # è·å–ä½¿ç”¨ç»Ÿè®¡
POST /api/billing/usage        # å¢åŠ ä½¿ç”¨è®¡æ•°

GET  /api/billing/branding     # æ£€æŸ¥å“ç‰Œæ ‡è¯†è®¾ç½®
```

### ä½¿ç”¨é™åˆ¶é›†æˆç¤ºä¾‹
```typescript
// åœ¨é¢„å”®åˆ›å»ºAPIä¸­é›†æˆè®¡è´¹æ£€æŸ¥
export default withUsageCheck('preorder_orders', async (req, res) => {
  // åˆ›å»ºé¢„å”®è®¢å•çš„é€»è¾‘
  // ä½¿ç”¨é‡ä¼šè‡ªåŠ¨æ£€æŸ¥å’Œé€’å¢
})

// æ£€æŸ¥åŠŸèƒ½è®¿é—®æƒé™
export default withFeatureCheck('partial_payments', async (req, res) => {
  // éƒ¨åˆ†ä»˜æ¬¾åŠŸèƒ½é€»è¾‘
  // åªæœ‰Proç”¨æˆ·å¯ä»¥è®¿é—®
})
```

## ğŸ“Š ä½¿ç”¨é™åˆ¶å®ç°

### 1. é¢„å”®è®¢å•é™åˆ¶
- **å…è´¹ç‰ˆ**: 1ä¸ª/æœˆ
- **Proç‰ˆ**: 100ä¸ª/æœˆ
- **æ£€æŸ¥æ—¶æœº**: åˆ›å»ºé¢„å”®è®¢å•æ—¶
- **è¶…é™å¤„ç†**: è¿”å›403é”™è¯¯ï¼Œæç¤ºå‡çº§

### 2. è¡¥è´§é‚®ä»¶é™åˆ¶
- **å…è´¹ç‰ˆ**: 50ä¸ª/æœˆ
- **Proç‰ˆ**: 1000ä¸ª/æœˆ
- **æ£€æŸ¥æ—¶æœº**: å‘é€è¡¥è´§é€šçŸ¥æ—¶
- **è¶…é™å¤„ç†**: åœæ­¢å‘é€ï¼Œæç¤ºå‡çº§

### 3. åŠŸèƒ½è®¿é—®æ§åˆ¶
- **éƒ¨åˆ†ä»˜æ¬¾**: ä»…Proç‰ˆ
- **é‚®ä»¶æ¨¡æ¿ç¼–è¾‘**: ä»…Proç‰ˆ
- **ç§»é™¤å“ç‰Œæ ‡è¯†**: ä»…Proç‰ˆ

## ğŸ¨ å“ç‰Œæ ‡è¯†æ§åˆ¶

### å‰ç«¯ç»„ä»¶
```tsx
import BrandingFooter from '@/components/BrandingFooter'

// è‡ªåŠ¨æ ¹æ®è®¡åˆ’æ˜¾ç¤º/éšè—å“ç‰Œæ ‡è¯†
<BrandingFooter shop={shop} />
```

### Widgeté›†æˆ
```javascript
// åœ¨å‰ç«¯widgetä¸­æ£€æŸ¥å“ç‰Œè®¾ç½®
const showBranding = await WidgetBranding.shouldShow(shop)
if (showBranding) {
  WidgetBranding.inject('preorder-widget')
}
```

## ğŸ”„ å‡çº§/é™çº§æµç¨‹

### å‡çº§åˆ°Pro
1. ç”¨æˆ·ç‚¹å‡»"Upgrade to Pro"
2. è°ƒç”¨ `PUT /api/billing/subscription`
3. æ›´æ–°è®¢é˜…è®¡åˆ’
4. ç«‹å³ç”Ÿæ•ˆï¼Œè§£é”æ‰€æœ‰åŠŸèƒ½
5. é‡ç½®ä½¿ç”¨è®¡æ•°åˆ°æ–°é™åˆ¶

### é™çº§åˆ°å…è´¹ç‰ˆ
1. ç”¨æˆ·ç‚¹å‡»"Downgrade to Free"
2. è°ƒç”¨ `PUT /api/billing/subscription`
3. æ›´æ–°è®¢é˜…è®¡åˆ’
4. ç«‹å³ç”Ÿæ•ˆï¼Œåº”ç”¨å…è´¹ç‰ˆé™åˆ¶
5. å¦‚æœå½“å‰ä½¿ç”¨è¶…è¿‡å…è´¹ç‰ˆé™åˆ¶ï¼Œé˜»æ­¢æ–°æ“ä½œ

## ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡å±•ç¤º

### å®æ—¶ä½¿ç”¨ç›‘æ§
```typescript
// è·å–å½“å‰ä½¿ç”¨æƒ…å†µ
const usage = await BillingSystem.getUsageSummary(shopId)

// è¿”å›æ ¼å¼
{
  preorder_orders: { current: 5, limit: 100 },
  restock_emails: { current: 23, limit: 1000 },
  partial_payments: { current: 0, limit: 999999 }
}
```

### ä½¿ç”¨è¿›åº¦æ¡
- ç»¿è‰²: 0-74% ä½¿ç”¨ç‡
- é»„è‰²: 75-89% ä½¿ç”¨ç‡  
- çº¢è‰²: 90-100% ä½¿ç”¨ç‡

### ä½¿ç”¨è­¦å‘Š
- 80%ä½¿ç”¨ç‡æ—¶æ˜¾ç¤ºè­¦å‘Š
- 90%ä½¿ç”¨ç‡æ—¶å¼ºè°ƒå‡çº§
- 100%ä½¿ç”¨ç‡æ—¶é˜»æ­¢æ“ä½œ

## ğŸ”’ å®‰å…¨å’ŒéªŒè¯

### æƒé™éªŒè¯
- æ‰€æœ‰è®¡è´¹APIéƒ½éªŒè¯åº—é“ºæƒé™
- ä½¿ç”¨ä¸­é—´ä»¶è‡ªåŠ¨æ£€æŸ¥é™åˆ¶
- é˜²æ­¢ç»•è¿‡è®¡è´¹é™åˆ¶

### æ•°æ®å®Œæ•´æ€§
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- è‡ªåŠ¨è®°å½•æ‰€æœ‰è®¡è´¹äº‹ä»¶
- å®šæœŸåŒæ­¥ä½¿ç”¨ç»Ÿè®¡

### é”™è¯¯å¤„ç†
- ä¼˜é›…å¤„ç†è®¡è´¹ç³»ç»Ÿé”™è¯¯
- é»˜è®¤å…è®¸æ“ä½œï¼ˆé™çº§ä½“éªŒï¼‰
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

## ğŸš€ éƒ¨ç½²å’Œé…ç½®

### æ•°æ®åº“è¿ç§»
```bash
# è¿è¡Œè®¡è´¹ç³»ç»Ÿè¿ç§»
psql -f supabase/migrations/20240930_billing_system.sql
```

### ç¯å¢ƒå˜é‡
```env
# è®¡è´¹ç›¸å…³é…ç½®
BILLING_WEBHOOK_SECRET=your_webhook_secret
STRIPE_SECRET_KEY=your_stripe_key (å¦‚æœé›†æˆStripe)
```

### åˆå§‹åŒ–
1. è¿è¡Œæ•°æ®åº“è¿ç§»
2. é»˜è®¤åˆ›å»ºFreeå’ŒProè®¡åˆ’
3. ä¸ºç°æœ‰åº—é“ºåˆ›å»ºå…è´¹è®¢é˜…
4. é…ç½®ä½¿ç”¨ç»Ÿè®¡è·Ÿè¸ª

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### æ£€æŸ¥é¢„å”®é™åˆ¶
```typescript
const usageCheck = await UsageMiddleware.checkPreorderLimit(shop)
if (!usageCheck.allowed) {
  return res.status(403).json({
    error: 'Preorder limit exceeded',
    message: usageCheck.message,
    upgrade_required: true
  })
}
```

### å¢åŠ ä½¿ç”¨è®¡æ•°
```typescript
const result = await UsageMiddleware.incrementAndCheck(shop, 'preorder_orders')
if (!result.allowed) {
  // å¤„ç†è¶…é™æƒ…å†µ
}
```

### æ£€æŸ¥åŠŸèƒ½æƒé™
```typescript
const hasAccess = await BillingSystem.canUseFeature(shopId, 'partial_payments')
if (!hasAccess) {
  return res.status(403).json({
    error: 'Feature not available on current plan'
  })
}
```

## ğŸ¯ æµ‹è¯•åœºæ™¯

### å…è´¹ç‰ˆé™åˆ¶æµ‹è¯•
1. åˆ›å»º1ä¸ªé¢„å”®è®¢å• âœ…
2. å°è¯•åˆ›å»ºç¬¬2ä¸ªé¢„å”®è®¢å• âŒ (åº”è¢«é˜»æ­¢)
3. å‘é€50ä¸ªè¡¥è´§é‚®ä»¶ âœ…
4. å°è¯•å‘é€ç¬¬51ä¸ªé‚®ä»¶ âŒ (åº”è¢«é˜»æ­¢)
5. å°è¯•ä½¿ç”¨éƒ¨åˆ†ä»˜æ¬¾ âŒ (åº”è¢«é˜»æ­¢)

### Proç‰ˆåŠŸèƒ½æµ‹è¯•
1. å‡çº§åˆ°Proç‰ˆ âœ…
2. åˆ›å»º100ä¸ªé¢„å”®è®¢å• âœ…
3. å‘é€1000ä¸ªè¡¥è´§é‚®ä»¶ âœ…
4. ä½¿ç”¨éƒ¨åˆ†ä»˜æ¬¾åŠŸèƒ½ âœ…
5. ç¼–è¾‘é‚®ä»¶æ¨¡æ¿ âœ…
6. å“ç‰Œæ ‡è¯†è¢«ç§»é™¤ âœ…

### å‡çº§/é™çº§æµ‹è¯•
1. ä»å…è´¹ç‰ˆå‡çº§åˆ°Pro âœ…
2. åŠŸèƒ½ç«‹å³è§£é” âœ…
3. ä»Proé™çº§åˆ°å…è´¹ç‰ˆ âœ…
4. åŠŸèƒ½ç«‹å³é™åˆ¶ âœ…

## ğŸ“Š ç›‘æ§å’Œåˆ†æ

### ä½¿ç”¨ç»Ÿè®¡
- æ¯æ—¥/æœˆåº¦ä½¿ç”¨æŠ¥å‘Š
- è®¡åˆ’è½¬æ¢ç‡åˆ†æ
- åŠŸèƒ½ä½¿ç”¨çƒ­åŠ›å›¾

### æ”¶å…¥è·Ÿè¸ª
- æœˆåº¦ç»å¸¸æ€§æ”¶å…¥(MRR)
- å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼(LTV)
- æµå¤±ç‡åˆ†æ

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’å¢å¼º
- å¹´åº¦è®¡åˆ’æŠ˜æ‰£
- ä¼ä¸šçº§è®¡åˆ’
- æŒ‰ä½¿ç”¨é‡è®¡è´¹

### åŠŸèƒ½æ‰©å±•
- è‡ªåŠ¨å‡çº§å»ºè®®
- ä½¿ç”¨é¢„æµ‹åˆ†æ
- ä¸ªæ€§åŒ–å®šä»·

## âœ… å®ç°çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | æ–‡ä»¶ |
|------|------|------|
| æ•°æ®åº“ç»“æ„ | âœ… å®Œæˆ | `supabase/migrations/20240930_billing_system.sql` |
| æ ¸å¿ƒè®¡è´¹é€»è¾‘ | âœ… å®Œæˆ | `lib/billing-system.ts` |
| ä½¿ç”¨é™åˆ¶ä¸­é—´ä»¶ | âœ… å®Œæˆ | `lib/usage-middleware.ts` |
| è®¡è´¹ç®¡ç†é¡µé¢ | âœ… å®Œæˆ | `pages/billing.tsx` |
| APIç«¯ç‚¹ | âœ… å®Œæˆ | `pages/api/billing/*` |
| å“ç‰Œæ ‡è¯†æ§åˆ¶ | âœ… å®Œæˆ | `components/BrandingFooter.tsx` |
| ä½¿ç”¨ç¤ºä¾‹ | âœ… å®Œæˆ | `pages/api/preorder/create-with-billing.ts` |

**æ€»ç»“**: PreOrder Pro è®¡è´¹ç³»ç»Ÿå·²å®Œå…¨å®ç°ï¼Œæ”¯æŒæ‰€æœ‰éœ€æ±‚çš„åŠŸèƒ½é™åˆ¶ã€ä½¿ç”¨ç»Ÿè®¡å’Œè®¡åˆ’ç®¡ç†ã€‚ç³»ç»Ÿè®¾è®¡çµæ´»ï¼Œæ˜“äºæ‰©å±•ï¼Œå®Œå…¨æ»¡è¶³å…è´¹ç‰ˆå’ŒProç‰ˆçš„å·®å¼‚åŒ–éœ€æ±‚ã€‚
