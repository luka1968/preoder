# ğŸ”§ æ‰‹åŠ¨å®‰è£…åº”ç”¨ï¼ˆç»•è¿‡ OAuthï¼‰

ç”±äºä½ çš„å•†åº—å‰å°æ— æ³•è®¿é—®å¯¼è‡´ OAuth SSL é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰‹åŠ¨å®‰è£…ï¼š

---

## æ–¹æ³• 1ï¼šåœ¨ Shopify Admin åˆ›å»º Custom App

### Step 1: å¯ç”¨è‡ªå®šä¹‰åº”ç”¨å¼€å‘

1. ç™»å½•ä½ çš„ Shopify Adminï¼š
   ```
   https://admin.shopify.com/store/anvi-shop
   ```

2. è¿›å…¥ **Settings** â†’ **Apps and sales channels**

3. ç‚¹å‡» **Develop apps**

4. å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œç‚¹å‡» **Allow custom app development**

---

### Step 2: åˆ›å»ºä½ çš„åº”ç”¨

1. ç‚¹å‡» **Create an app**

2. å¡«å†™ä¿¡æ¯ï¼š
   - **App name**: `Preorder Pro`
   - **App developer**: ä½ çš„é‚®ç®±

3. ç‚¹å‡» **Create app**

---

### Step 3: é…ç½® API scopes

1. ç‚¹å‡» **Configuration**

2. åœ¨ **Admin API integration** éƒ¨åˆ†ï¼Œç‚¹å‡» **Configure**

3. é€‰æ‹©ä»¥ä¸‹æƒé™ï¼ˆScopesï¼‰ï¼š

   **å¿…éœ€çš„æƒé™**ï¼š
   - âœ… `read_products`
   - âœ… `write_products`
   - âœ… `read_orders`
   - âœ… `write_orders`
   - âœ… `read_draft_orders`
   - âœ… `write_draft_orders`
   - âœ… `read_inventory`
   - âœ… `write_inventory`
   - âœ… `read_customers`
   - âœ… `write_customers`
   - âœ… `read_themes`
   - âœ… `write_themes`

4. ç‚¹å‡» **Save**

---

### Step 4: å®‰è£…åº”ç”¨

1. å›åˆ° **Overview** æ ‡ç­¾

2. ç‚¹å‡» **Install app**

3. ç¡®è®¤å®‰è£…

---

### Step 5: è·å– Access Token

1. å®‰è£…å®Œæˆåï¼Œåœ¨ **API credentials** æ ‡ç­¾

2. ç‚¹å‡» **Reveal token once**ï¼ˆâš ï¸ åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè®°å¾—å¤åˆ¶ä¿å­˜ï¼ï¼‰

3. å¤åˆ¶ **Admin API access token**ï¼Œä¾‹å¦‚ï¼š
   ```
   shpat_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

---

### Step 6: æ·»åŠ åˆ° Supabase æ•°æ®åº“

1. ç™»å½• Supabase Dashboard: https://supabase.com

2. é€‰æ‹©ä½ çš„é¡¹ç›®

3. è¿›å…¥ **SQL Editor**

4. è¿è¡Œä»¥ä¸‹ SQLï¼š

```sql
INSERT INTO shops (
    shop_domain,
    access_token,
    installed_at
) VALUES (
    'anvi-shop.myshopify.com',
    'ä½ åœ¨Step5å¤åˆ¶çš„Access_Token',
    NOW()
)
ON CONFLICT (shop_domain)
DO UPDATE SET
    access_token = EXCLUDED.access_token,
    updated_at = NOW();
```

5. ç‚¹å‡» **Run**

---

### Step 7: éªŒè¯å®‰è£…

è®¿é—®ç®¡ç†ç•Œé¢ï¼š
```
https://shopmall.dpdns.org/admin?shop=anvi-shop.myshopify.com
```

åº”è¯¥èƒ½çœ‹åˆ° Dashboard äº†ï¼

---

## æ–¹æ³• 2ï¼šä½¿ç”¨ Shopify CLIï¼ˆå¼€å‘è€…æ–¹å¼ï¼‰

å¦‚æœä½ ç†Ÿæ‚‰å‘½ä»¤è¡Œï¼š

### Step 1: å®‰è£… Shopify CLI

```bash
npm install -g @shopify/cli @shopify/app
```

### Step 2: åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•è¿è¡Œ

```bash
shopify app dev
```

### Step 3: æŒ‰æç¤ºç™»å½•å¹¶é€‰æ‹©ä½ çš„åº—é“º

---

## æ–¹æ³• 3ï¼šç›´æ¥æµ‹è¯•ï¼ˆä¸å®‰è£…ï¼‰

å¦‚æœåªæ˜¯æƒ³æµ‹è¯•åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥ï¼š

### 1. åˆ›å»ºæµ‹è¯• Access Token

æŒ‰ç…§æ–¹æ³• 1 çš„ Step 1-5 è·å– Access Token

### 2. æ‰‹åŠ¨æµ‹è¯• API

ä½¿ç”¨ Postman æˆ– curl æµ‹è¯•ï¼š

```bash
curl -X POST https://shopmall.dpdns.org/api/preorder/create \
  -H "Content-Type: application/json" \
  -d '{
    "shop": "anvi-shop.myshopify.com",
    "productId": "ä½ çš„äº§å“ID",
    "variantId": "ä½ çš„å˜ä½“ID",
    "email": "test@example.com",
    "quantity": 1
  }'
```

---

## âœ… å®Œæˆåçš„æµ‹è¯•æ¸…å•

å®‰è£…å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹åŠŸèƒ½ï¼š

- [ ] èƒ½è®¿é—®ç®¡ç†ç•Œé¢ `https://shopmall.dpdns.org/admin?shop=anvi-shop.myshopify.com`
- [ ] Dashboard æ˜¾ç¤ºæ•°æ®
- [ ] Products é¡µé¢èƒ½åˆ—å‡ºäº§å“
- [ ] èƒ½å¯ç”¨/ç¦ç”¨äº§å“çš„é¢„è´­åŠŸèƒ½
- [ ] å‰ç«¯è„šæœ¬èƒ½æ­£ç¡®æ˜¾ç¤ºé¢„è´­æŒ‰é’®
- [ ] èƒ½æäº¤æµ‹è¯•è®¢å•
- [ ] Shopify Draft Orders ä¸­èƒ½çœ‹åˆ°æ–°è®¢å•

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: è¿è¡Œ SQL åæç¤º shops è¡¨ä¸å­˜åœ¨

**A**: éœ€è¦å…ˆåˆ›å»ºè¡¨ç»“æ„ã€‚è¿è¡Œï¼š

```sql
CREATE TABLE IF NOT EXISTS shops (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    shop_domain TEXT UNIQUE NOT NULL,
    access_token TEXT NOT NULL,
    installed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Q: ç®¡ç†ç•Œé¢æ˜¾ç¤º "Shop not found"

**A**: æ£€æŸ¥ï¼š
1. Supabase ä¸­ shops è¡¨æ˜¯å¦æœ‰è®°å½•
2. shop_domain æ˜¯å¦å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬ `.myshopify.com`ï¼‰
3. access_token æ˜¯å¦æ­£ç¡®

### Q: API è°ƒç”¨è¿”å› 401 Unauthorized

**A**: Access Token å¯èƒ½æ— æ•ˆæˆ–è¿‡æœŸï¼š
1. åœ¨ Shopify Admin é‡æ–°ç”Ÿæˆ token
2. æ›´æ–° Supabase ä¸­çš„è®°å½•

---

**æ¨èä½¿ç”¨æ–¹æ³• 1ï¼Œæœ€ç®€å•ç›´æ¥ï¼** âœ¨
