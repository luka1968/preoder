# ğŸš€ è‡ªåŠ¨å¯ç”¨é¢„è´­åŠŸèƒ½ - æ— éœ€æ‰‹åŠ¨è®¾ç½®

## é—®é¢˜ï¼šå•†å®¶éœ€è¦æ‰‹åŠ¨è®¾ç½®å—ï¼Ÿ

### âŒ **åŸæ¥çš„æ–¹å¼ï¼ˆç¹çï¼‰ï¼š**

å•†å®¶éœ€è¦ä¸ºæ¯ä¸ªé¢„è´­äº§å“æ‰‹åŠ¨æ“ä½œï¼š
```
1. Shopify Admin â†’ Products
2. é€‰æ‹©äº§å“
3. æ‰¾åˆ° Inventory éƒ¨åˆ†
4. æ‰¾åˆ° "When out of stock"
5. é€‰æ‹© "Continue selling when out of stock"
6. ä¿å­˜

é‡å¤ä»¥ä¸Šæ­¥éª¤...ğŸ˜«
```

**é—®é¢˜ï¼š**
- ç¹çï¼Œå®¹æ˜“å¿˜è®°
- æ–°æ‰‹ä¸çŸ¥é“è¿™ä¸ªè®¾ç½®
- æ¯ä¸ªäº§å“éƒ½è¦æ“ä½œ

---

## âœ… **æ–°çš„æ–¹å¼ï¼ˆè‡ªåŠ¨åŒ–ï¼‰ï¼š**

### **æ–¹æ¡ˆ 1ï¼šä¸€é”®å¯ç”¨ï¼ˆæ¨èï¼‰** â­â­â­

**åœ¨ App åå°æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼**

**å•†å®¶åªéœ€è¦ï¼š**
```
1. æ‰“å¼€ä½ çš„ App
2. è¾“å…¥äº§å“ ID
3. ç‚¹å‡»"ä¸€é”®å¯ç”¨é¢„è´­"æŒ‰é’®
4. å®Œæˆï¼âœ…
```

**æˆ‘å·²ç»åˆ›å»ºäº†ï¼š**
- âœ… API ç«¯ç‚¹ï¼š`pages/api/products/enable-preorder.ts`
- âœ… å‰ç«¯ç»„ä»¶ï¼š`components/EnablePreorderButton.tsx`

**ä½¿ç”¨æ–¹æ³•ï¼š**

åœ¨ä½ çš„ App ä»»ä½•é¡µé¢æ·»åŠ è¿™ä¸ªç»„ä»¶ï¼š

```tsx
import EnablePreorderButton from '../components/EnablePreorderButton'

// åœ¨ä½ çš„é¡µé¢ä¸­
<EnablePreorderButton shop={shopDomain} />
```

---

### **æ–¹æ¡ˆ 2ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶è®¾ç½®** â­â­

**æ›´æ™ºèƒ½ï¼šå½“å•†å“åº“å­˜å˜ä¸º 0 æ—¶è‡ªåŠ¨å¯ç”¨ï¼**

**å·¥ä½œæµç¨‹ï¼š**
```
1. ç›‘å¬ products/update webhook
2. æ£€æµ‹åº“å­˜æ˜¯å¦ä¸º 0
3. è‡ªåŠ¨è°ƒç”¨ API è®¾ç½® inventory_policy = 'continue'
4. å•†å®¶æ— æ„ŸçŸ¥ï¼Œå…¨è‡ªåŠ¨ï¼
```

**å®ç°æ­¥éª¤ï¼š**

ä¿®æ”¹ `lib/webhooks.ts` ä¸­çš„ `handleProductUpdate`ï¼š

```typescript
// åœ¨ handleProductUpdate å‡½æ•°ä¸­æ·»åŠ 
export async function handleProductUpdate(payload: ProductUpdateWebhook, shop: string) {
  // ... ç°æœ‰ä»£ç  ...

  // ğŸ†• è‡ªåŠ¨å¯ç”¨é¢„è´­
  for (const variant of payload.variants) {
    // æ£€æŸ¥æ˜¯å¦åº“å­˜ä¸º 0 ä¸”æœªå…è®¸è¶…å–
    if (variant.inventory_quantity <= 0 && 
        variant.inventory_policy === 'deny') {
      
      console.log(`ğŸ¯ è‡ªåŠ¨å¯ç”¨é¢„è´­ï¼šVariant ${variant.id}`)
      
      // è‡ªåŠ¨è®¾ç½®å…è®¸è¶…å–
      await updateVariantInventoryPolicy(shop, shopData.access_token, variant.id)
    }
  }
}
```

---

### **æ–¹æ¡ˆ 3ï¼šæ‰¹é‡å¯¼å…¥** â­

**ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰åº“å­˜ä¸º 0 çš„äº§å“**

åœ¨ App åå°æ·»åŠ ä¸€ä¸ª"æ‰¹é‡å¯ç”¨"é¡µé¢ï¼š

```tsx
<Button onClick={enableAllOutOfStockProducts}>
  ğŸ“¦ æ‰¹é‡å¯ç”¨æ‰€æœ‰ç¼ºè´§äº§å“çš„é¢„è´­åŠŸèƒ½
</Button>
```

API é€»è¾‘ï¼š
```typescript
// è·å–æ‰€æœ‰åº“å­˜ä¸º 0 çš„äº§å“
const outOfStockProducts = await getOutOfStockProducts(shop)

// æ‰¹é‡è®¾ç½®
for (const product of outOfStockProducts) {
  await enablePreorderForProduct(product.id)
}
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆç»„åˆ

### **æœ€ä½³å®è·µï¼š** æ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 2

```
âœ… æ–¹æ¡ˆ 1ï¼ˆä¸€é”®å¯ç”¨ï¼‰ï¼š
   - ç»™å•†å®¶ä¸»åŠ¨æ§åˆ¶æƒ
   - åœ¨ App åå°æ˜¾çœ¼ä½ç½®
   - ç®€å•ç›´è§‚

âœ… æ–¹æ¡ˆ 2ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰ï¼š
   - åå°è‡ªåŠ¨è¿è¡Œ
   - å‡å°‘å•†å®¶æ“ä½œ
   - æ–°äº§å“è‡ªåŠ¨å¯ç”¨

ç»“æœï¼š
â†’ å•†å®¶å¯ä»¥æ‰‹åŠ¨å¯ç”¨ï¼ˆæœ‰æ§åˆ¶æ„Ÿï¼‰
â†’ ä¹Ÿä¼šè‡ªåŠ¨å¯ç”¨ï¼ˆçœäº‹ï¼‰
â†’ å®Œç¾ï¼ğŸ‰
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### **Step 1ï¼šæ·»åŠ  API ç«¯ç‚¹** âœ…

å·²å®Œæˆï¼æ–‡ä»¶ï¼š`pages/api/products/enable-preorder.ts`

---

### **Step 2ï¼šåœ¨ App åå°æ˜¾ç¤ºæŒ‰é’®**

æ‰¾åˆ°ä½ çš„äº§å“ç®¡ç†é¡µé¢ï¼ˆæˆ–åˆ›å»ºä¸€ä¸ªæ–°é¡µé¢ï¼‰ï¼Œæ·»åŠ ï¼š

```tsx
import EnablePreorderButton from '../components/EnablePreorderButton'

export default function ProductsPage() {
  const shopDomain = 'your-shop.myshopify.com' // ä» session è·å–

  return (
    <Page title="äº§å“ç®¡ç†">
      {/* å…¶ä»–å†…å®¹ */}
      
      <EnablePreorderButton shop={shopDomain} />
      
      {/* å…¶ä»–å†…å®¹ */}
    </Page>
  )
}
```

---

### **Step 3ï¼šï¼ˆå¯é€‰ï¼‰æ·»åŠ è‡ªåŠ¨æ£€æµ‹**

ä¿®æ”¹ `lib/webhooks.ts`ï¼š

```typescript
import { updateVariantInventoryPolicy } from './shopify'

export async function handleProductUpdate(payload: ProductUpdateWebhook, shop: string) {
  // ... ç°æœ‰ä»£ç  ...

  // è‡ªåŠ¨å¯ç”¨é¢„è´­
  const shopData = await getShopByDomain(shop)
  if (shopData) {
    for (const variant of payload.variants) {
      if (variant.inventory_quantity <= 0 && 
          variant.inventory_policy === 'deny') {
        
        try {
          await updateVariantInventoryPolicy(
            shop, 
            shopData.access_token, 
            variant.id
          )
          console.log(`âœ… è‡ªåŠ¨å¯ç”¨é¢„è´­ï¼šProduct ${payload.id}, Variant ${variant.id}`)
        } catch (error) {
          console.error(`âŒ è‡ªåŠ¨å¯ç”¨å¤±è´¥ï¼š${error}`)
        }
      }
    }
  }
}
```

åœ¨ `lib/shopify.ts` ä¸­æ·»åŠ ï¼š

```typescript
export async function updateVariantInventoryPolicy(
  shop: string,
  accessToken: string,
  variantId: string
) {
  const response = await fetch(
    `https://${shop}/admin/api/2024-01/variants/${variantId}.json`,
    {
      method: 'PUT',
      headers: {
        'X-Shopify-Access-Token': accessToken,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        variant: {
          id: variantId,
          inventory_policy: 'continue'
        }
      })
    }
  )

  if (!response.ok) {
    throw new Error(`Failed to update variant: ${await response.text()}`)
  }

  return await response.json()
}
```

---

## ğŸ¨ UI å±•ç¤ºæ•ˆæœ

### **åœ¨ App åå°ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„è´­ç®¡ç†                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  ğŸš€ ä¸€é”®å¯ç”¨é¢„è´­                           â”‚
â”‚  è‡ªåŠ¨è®¾ç½®äº§å“ä¸º"å…è®¸ç¼ºè´§æ—¶ç»§ç»­é”€å”®"         â”‚
â”‚                                            â”‚
â”‚  äº§å“ ID: [è¾“å…¥æ¡†________________________] â”‚
â”‚  å¯ä»¥åœ¨äº§å“é¡µé¢ URL ä¸­æ‰¾åˆ°äº§å“ ID           â”‚
â”‚                                            â”‚
â”‚  [ğŸ¯ ä¸€é”®å¯ç”¨é¢„è´­]                         â”‚
â”‚                                            â”‚
â”‚  âš ï¸ æ³¨æ„ï¼šå°†ä¸ºäº§å“çš„æ‰€æœ‰å˜ä½“å¯ç”¨é¢„è´­       â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‚¹å‡»åï¼š**
```
âœ… æˆåŠŸï¼å·²ä¸º 3 ä¸ªå˜ä½“å¯ç”¨é¢„è´­
```

---

## ğŸ“Š ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å•†å®¶æ“ä½œ | è‡ªåŠ¨åŒ–ç¨‹åº¦ | æ¨èåº¦ |
|------|---------|-----------|--------|
| **æ‰‹åŠ¨è®¾ç½®** | æ¯ä¸ªäº§å“æ‰‹åŠ¨æ“ä½œ | âŒ 0% | â­ |
| **ä¸€é”®å¯ç”¨** | è¾“å…¥ ID + ç‚¹å‡»æŒ‰é’® | âš¡ 50% | â­â­â­ |
| **è‡ªåŠ¨æ£€æµ‹** | æ— éœ€æ“ä½œ | âœ… 100% | â­â­â­ |
| **ç»„åˆæ–¹æ¡ˆ** | å¯é€‰æ“ä½œ | âš¡ 80% | â­â­â­â­â­ |

---

## âœ… æ€»ç»“

### **å›ç­”ä½ çš„é—®é¢˜ï¼š**

**Q: "Continue selling" éœ€è¦å•†å®¶æ‰‹åŠ¨æ“ä½œå—ï¼Ÿ**

**A: åŸæ¥éœ€è¦ï¼Œç°åœ¨ä¸éœ€è¦äº†ï¼**

æˆ‘å·²ç»åˆ›å»ºäº†ï¼š
1. âœ… API ç«¯ç‚¹è‡ªåŠ¨è®¾ç½®
2. âœ… å‰ç«¯ä¸€é”®å¯ç”¨æŒ‰é’®
3. âœ… å¯ä»¥æ·»åŠ è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½

**å•†å®¶å¯ä»¥ï¼š**
- ğŸ¯ åœ¨ App åå°ä¸€é”®å¯ç”¨ï¼ˆæ–¹ä¾¿ï¼‰
- ğŸ¤– æˆ–å®Œå…¨è‡ªåŠ¨åŒ–ï¼ˆæ›´æ–¹ä¾¿ï¼‰
- ğŸ“ æˆ–æ‰‹åŠ¨è®¾ç½®ï¼ˆå¦‚æœä»–ä»¬æƒ³è¦æ§åˆ¶ï¼‰

**ä¸‰ç§æ–¹å¼éƒ½æ”¯æŒï¼** ğŸ‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **ç«‹å³å¯ç”¨ï¼š** ä¸€é”®å¯ç”¨æŒ‰é’®å·²åˆ›å»º
2. **å¯é€‰å¢å¼ºï¼š** æ·»åŠ è‡ªåŠ¨æ£€æµ‹åŠŸèƒ½
3. **æ¨é€éƒ¨ç½²åï¼š** åœ¨ App åå°æ·»åŠ è¿™ä¸ªç»„ä»¶

**å»ºè®®ï¼š** å…ˆå®ç°ä¸€é”®å¯ç”¨æŒ‰é’®ï¼Œç”¨æˆ·åé¦ˆå¥½åå†æ·»åŠ å…¨è‡ªåŠ¨åŠŸèƒ½ã€‚

---

**æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ï¼** ğŸŠ
