# 🔍 PreOrder Pro 全面问题分析报告

**生成时间**: 2025-11-30
**检查范围**: 代码、配置、功能完整性
**对标应用**: Globo Pre-Order

---

## 🔴 严重问题（必须修复才能上线）

### 1. ❌ OAuth 安装流程不完整

**问题描述**:
- `/api/auth/index.ts` 缺少 `state` 参数验证
- 没有实现 CSRF 保护
- `state` 参数生成后未保存到 session

**影响**:
- 安全漏洞：容易受到 CSRF 攻击
- OAuth 流程可能被劫持

**修复建议**:
```typescript
// 需要添加 state 验证
const state = crypto.randomBytes(16).toString('hex');
// 保存到 session 或 cookie
res.setHeader('Set-Cookie', `oauth_state=${state}; HttpOnly; Secure`);
```

---

### 2. ❌ Callback 处理缺少完整性验证

**文件**: `pages/api/auth/callback.ts`

**问题**:
- 没有验证 `state` 参数
- 没有验证 HMAC 签名
- 缺少错误处理

**代码问题**:
```typescript
// 当前代码
const { code, shop } = req.query

// 缺少：
// 1. state 验证
// 2. HMAC 验证
// 3. shop 域名格式验证
```

---

### 3. ❌ 数据库表结构可能不完整

**需要检查**:
- `shops` 表是否包含所有必需字段？
- `preorder_orders` 表是否正确？
- 索引是否优化？

让我检查数据库迁移文件...

---

### 4. ❌ 前端脚本 API URL 硬编码

**文件**: `public/universal-preorder.js` 第 13 行

**问题**:
```javascript
apiUrl: 'https://shopmall.dpdns.org/api',  // ❌ 硬编码
```

**影响**:
- 无法在不同环境使用
- 部署到其他域名会失败

**修复**:
```javascript
apiUrl: window.PREORDER_CONFIG?.apiUrl || window.location.origin + '/api',
```

---

## 🟡 中等问题（影响功能但不阻碍上线）

### 5. ⚠️ 缺少 Webhook 处理

**缺失的 Webhooks**:
- ❌ `orders/paid` - 订单支付通知
- ❌ `orders/fulfilled` - 订单发货通知
- ❌ `products/update` - 产品更新（库存变化）
- ❌ `app/uninstalled` - 应用卸载清理

**Globo有但我们没有**:
- 自动库存同步
- 订单状态更新
- 用户数据清理

---

### 6. ⚠️ 邮件通知功能不完整

**问题**:
- 有 `nodemailer` 依赖但没看到邮件发送代码
- 缺少邮件模板
- 没有邮件队列系统

**需要实现**:
1. 预购成功通知
2. 到货通知
3. 付款提醒

---

### 7. ⚠️ 前端没有多语言支持

**当前**:
- 硬编码中文文本
- 没有 i18n 系统

**Globo 有**:
- 多语言支持
- 可自定义文本

---

### 8. ⚠️ 缺少 Metafield 管理

**Globo 的核心功能**:
- 使用 `product.metafields.preorder_enabled`
- 使用 `product.metafields.expected_date`

**我们的问题**:
- 没有看到 Metafield API 调用
- 数据可能只存在 Supabase，Shopify 不同步

---

## 🟢 轻微问题（优化建议）

### 9. 💡 错误处理不完善

- API 返回错误信息不够详细
- 没有统一的错误格式
- 缺少错误日志

### 10. 💡 没有速率限制

- API 端点没有速率限制
- 容易被滥用

### 11. 💡 缺少数据分析

**Globo 有的分析功能**:
- 预购转化率
- 热门预购产品
- 收入预测

**我们缺少**:
- Dashboard 有但数据可能不准确
- 缺少详细报表

---

## 📋 与 Globo Pre-Order 功能对比

| 功能 | Globo | 我们 | 状态 |
|------|-------|------|------|
| 🛍️ 预购按钮显示 | ✅ | ✅ | ✅ 有 |
| 📧 邮件通知 | ✅ | ❌ | ❌ 缺失 |
| 🔄 库存同步 | ✅ | ❌ | ❌ 缺失 |
| 📊 Metafield 管理 | ✅ | ❓ | ⚠️ 未确认 |
| 💰 Draft Order 创建 | ✅ | ✅ | ✅ 有 |
| 🎨 自定义样式 | ✅ | ⚠️ | ⚠️ 部分支持 |
| 🌍 多语言 | ✅ | ❌ | ❌ 缺失 |
| 📱 App Embed | ✅ | ✅ | ✅ 有 |
| ⚙️ Webhook 处理 | ✅ | ❌ | ❌ 缺失 |
| 📈 数据分析 | ✅ | ⚠️ | ⚠️ 基础功能 |
| 🔐 OAuth 安全 | ✅ | ❌ | ❌ 不完整 |
| 💳 付款处理 | ✅ | ✅ | ✅ 有 |

---

## 🚨 立即需要修复的问题（优先级排序）

### P0 - 最高优先级（阻碍上线）

1. ✅ **修复 OAuth 流程**
   - 添加 state 验证
   - 添加 HMAC 验证
   - 完善错误处理

2. ✅ **检查并修复数据库**
   - 验证表结构
   - 添加必要索引
   - 创建缺失的表

3. ✅ **修复前端硬编码**
   - 移除硬编码的 API URL
   - 使用动态配置

### P1 - 高优先级（影响核心功能）

4. ⚠️ **实现 Webhook 处理**
   - 库存更新
   - 订单状态同步
   - App 卸载清理

5. ⚠️ **邮件通知系统**
   - 预购成功通知
   - 到货通知

6. ⚠️ **Metafield 同步**
   - 产品预购状态
   - 预计到货日期

### P2 - 中优先级（功能完善）

7. 💡 多语言支持
8. 💡 自定义样式编辑器
9. 💡 数据分析增强

---

## 🔍 需要进一步检查的文件

1. [ ] `lib/shopify.ts` - Shopify API 客户端
2. [ ] `supabase/*.sql` - 数据库迁移文件
3. [ ] `pages/api/webhooks/*` - Webhook 处理
4. [ ] `pages/api/preorder/create.ts` - 订单创建逻辑

---

## 📝 下一步行动计划

### 第一阶段（必须完成才能上线）

1. 修复 OAuth 安全问题
2. 检查并修复数据库
3. 移除硬编码配置
4. 添加基本错误处理

### 第二阶段（功能完善）

5. 实现 Webhook 处理
6. 添加邮件通知
7. Metafield 同步

### 第三阶段（优化增强）

8. 多语言支持
9. 数据分析
10. 性能优化

---

**待继续检查**: 数据库文件、Shopify API 集成、Webhook 实现
