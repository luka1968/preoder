# 🚀 本地开发和部署完整指南

## ✅ 配置已完成

所有密钥已经配置到项目中：

- ✅ `.env` - 生产环境变量
- ✅ `.env.local` - 本地开发变量
- ✅ `shopify.app.toml` - Shopify CLI 配置

---

## 📋 第一步：安装依赖

### 1. 安装项目依赖

```bash
npm install
```

### 2. 安装 Shopify CLI

```bash
npm install -g @shopify/cli @shopify/app
```

### 3. 安装 Vercel CLI

```bash
npm install -g vercel
```

---

## 🔧 第二步：本地开发

### 启动开发服务器

```bash
# 方法1: 使用 npm
npm run dev

# 方法2: 使用 Shopify CLI（推荐）
shopify app dev
```

访问：`http://localhost:3000`

---

## 🚀 第三步：部署到 Vercel

### 使用 Vercel CLI 部署

```bash
# 1. 登录 Vercel
vercel login

# 2. 部署到生产环境
vercel --prod
```

### 或使用脚本

```bash
# Windows
vercel-deploy.bat

# 选择选项 3: 部署到生产环境
```

### 部署后记录 URL

例如：`https://shopmall.dpdns.org`

---

## 📦 第四步：部署 Shopify 扩展

### 1. 登录 Shopify

```bash
shopify auth login
```

### 2. 部署 App Embed 扩展

```bash
# 进入扩展目录
cd extensions/preorder-embed

# 部署扩展
shopify app deploy

# 返回项目根目录
cd ../..
```

### 3. 确认部署成功

在 [Shopify Partners](https://partners.shopify.com/) 后台查看：
- 进入你的 App
- 点击 "Extensions"
- 应该能看到 "PreOrder Pro" 扩展

---

## 🧪 第五步：测试

### 1. 安装 App 到开发店铺

```bash
# 使用 Shopify CLI
shopify app dev

# 或在 Partners 后台手动安装
```

### 2. 启用 App Embed

1. 进入 Shopify Admin
2. Online Store → Themes → Customize
3. 点击左侧 "App embeds"
4. 找到 "PreOrder Pro - 预购插件"
5. 打开开关
6. Save

### 3. 创建测试商品

1. Products → Add product
2. 设置库存为 **0**
3. Save

### 4. 访问商品页面验证

应该看到：
- ✅ 预购按钮（橙色渐变）
- ✅ 预购徽章（图片右上角）
- ✅ 原"加入购物车"按钮隐藏

### 5. 检查浏览器控制台

按 F12，应该看到：
```
🚀 PreOrder Pro App Embed Block Loaded
📊 Config: {...}
✅ PreOrder Universal Widget loaded via App Embed
✅ Variant sold out via Shopify data
✅ Preorder button inserted
🎉 PreOrder Widget initialized successfully!
```

---

## 🔄 日常开发流程

### 修改代码后

```bash
# 1. 测试本地
npm run dev

# 2. 部署到 Vercel
vercel --prod

# 3. 如果修改了扩展，重新部署
cd extensions/preorder-embed
shopify app deploy
cd ../..
```

---

## 📝 环境变量管理

### 本地开发

使用 `.env.local`（已配置）

### Vercel 生产环境

两种方式设置：

#### 方法1: 通过 Dashboard

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 选择项目
3. Settings → Environment Variables
4. 添加所有变量

#### 方法2: 通过 CLI

```bash
# 添加单个变量
vercel env add SHOPIFY_API_KEY production

# 从 .env 文件导入
vercel env pull .env.production
```

---

## 🔍 常用命令

### Shopify CLI

```bash
# 查看版本
shopify version

# 登录
shopify auth login

# 启动开发服务器
shopify app dev

# 部署扩展
shopify app deploy

# 查看 App 信息
shopify app info

# 查看扩展列表
shopify app extension list
```

### Vercel CLI

```bash
# 查看版本
vercel --version

# 登录
vercel login

# 部署到预览
vercel

# 部署到生产
vercel --prod

# 查看部署列表
vercel ls

# 查看部署日志
vercel logs

# 查看环境变量
vercel env ls
```

### NPM

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

---

## 🐛 问题排查

### 问题1: Shopify CLI 找不到配置

**解决方法：**
```bash
# 确认 shopify.app.toml 存在
dir shopify.app.toml

# 确认 client_id 已设置
type shopify.app.toml | findstr client_id
```

### 问题2: 环境变量未加载

**解决方法：**
```bash
# 检查 .env.local 文件
type .env.local

# 重启开发服务器
npm run dev
```

### 问题3: 扩展部署失败

**解决方法：**
```bash
# 检查扩展配置
type extensions\preorder-embed\shopify.extension.toml

# 重新登录
shopify auth logout
shopify auth login

# 重新部署
cd extensions\preorder-embed
shopify app deploy
```

### 问题4: Vercel 部署失败

**解决方法：**
```bash
# 检查构建日志
vercel logs

# 重新登录
vercel logout
vercel login

# 重新部署
vercel --prod
```

---

## 📊 项目结构

```
preorder-pro/
├── .env                          # 生产环境变量 ✅
├── .env.local                    # 本地开发变量 ✅
├── shopify.app.toml              # Shopify CLI 配置 ✅
├── extensions/
│   └── preorder-embed/
│       ├── shopify.extension.toml
│       ├── blocks/
│       │   └── app_embed.liquid
│       └── assets/
│           └── preorder-universal.js
├── public/
│   ├── shopify-integration.js    # 修复后的脚本 ✅
│   └── universal-preorder.js     # App Embed 使用 ✅
├── pages/
│   └── api/
│       ├── install-script-tag.ts
│       └── uninstall-script-tag.ts
└── vercel-deploy.bat             # 部署脚本 ✅
```

---

## ✅ 检查清单

### 配置完成
- [x] `.env` 文件已配置
- [x] `.env.local` 文件已配置
- [x] `shopify.app.toml` 已更新
- [x] 依赖已安装

### 开发环境
- [ ] Shopify CLI 已安装
- [ ] Vercel CLI 已安装
- [ ] 本地服务器可以启动
- [ ] 可以访问 localhost:3000

### 部署
- [ ] Vercel 部署成功
- [ ] Shopify 扩展部署成功
- [ ] App 已安装到开发店铺
- [ ] App Embed 已启用

### 测试
- [ ] 测试商品已创建（库存=0）
- [ ] 预购按钮显示正常
- [ ] 预购徽章显示正常
- [ ] 点击功能正常
- [ ] 控制台无错误

---

## 🎉 完成！

现在你可以：

1. **本地开发**：`npm run dev` 或 `shopify app dev`
2. **部署到 Vercel**：`vercel --prod` 或运行 `vercel-deploy.bat`
3. **部署扩展**：`cd extensions/preorder-embed && shopify app deploy`
4. **测试功能**：在开发店铺创建库存为0的商品

**所有配置已完成，可以开始开发和部署了！** 🚀

---

## ⚠️ 安全提醒

**重要：** 这些密钥已经在聊天中泄露，建议：

1. 部署完成后，立即重新生成所有密钥
2. 更新 `.env` 和 `.env.local` 文件
3. 更新 Vercel 环境变量
4. 更新 `shopify.app.toml` 中的 client_id

**永远不要在公共场合分享密钥！** 🔒
